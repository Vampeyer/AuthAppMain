<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Premium Content (Client-Side)</title>
  <base href="/streampaltest/public/">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <nav>
    <a href="index.html">Home</a> |
    <a href="signup.html">Sign Up</a> |
    <a href="login.html">Login</a> |
    <a href="profile.html">Profile</a> |
    <a href="premium2.html">Premium</a>
  </nav>

  <!-- Loading state (shown while checking access) -->
  <div class="container" id="loading" style="text-align:center;padding:40px;">
    <h2>üîí Verifying access...</h2>
    <p>Please wait while we check your subscription...</p>
  </div>

  <!-- Premium content (hidden until verified) -->
  <div class="container" id="premium" style="display:none;">


    


  </div>

<script>
const BACKEND_URL = 'https://authappmain.onrender.com';

// Helper function to get auth headers
async function getHeaders() {
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// ====================
// CHECK SUBSCRIPTION ACCESS
// This is CLIENT-SIDE protection - checks via API call
// ====================
async function checkAccess() {
  console.log('üîç Checking subscription access...');
  
  const token = localStorage.getItem('token');
  
  // First check: Do they have a token?
  if (!token) {
    console.log('‚ùå No token found');
    alert('Please log in first');
    window.location.href = 'login.html';
    return;
  }

  try {
    // Call the /api/me endpoint to check subscription status
    const response = await fetch(`${BACKEND_URL}/api/me`, { 
      method: 'GET',
      credentials: 'include', // Send cookies if available
      headers: await getHeaders()
    });

    console.log('API Response status:', response.status);

    // Handle authentication errors
    if (!response.ok) {
      if (response.status === 401) {
        console.log('‚ùå Authentication failed');
        alert('Session expired. Please log in again.');
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      } else {
        throw new Error('Failed to verify access');
      }
      return;
    }

    // Parse the user data
    const user = await response.json();
    console.log('User data received:', user);

    // Check if subscription is active
    if (user.subscription_active) {
      // ‚úÖ ACCESS GRANTED!
      document.getElementById('loading').style.display = 'none';
      document.getElementById('premium').style.display = 'block';
      console.log('‚úÖ Access granted - subscription is active');
      console.log(`   Days left: ${user.days_left}`);
    } else {
      // ‚ùå NO SUBSCRIPTION
      console.log('‚ùå No active subscription');
      alert('Must have subscription to access this content');
      window.location.href = 'profile.html';
    }

  } catch (error) {
    console.error('Error checking access:', error);
    alert('Error verifying access. Please try again.');
    window.location.href = 'login.html';
  }
}

// Run the access check when the page loads
checkAccess();
</script>
</body>
</html>