<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

  <nav>
    <a href="/">Home</a>
    <a href="/signup.html">Sign Up</a>
    <a href="/login.html">Login</a>
    <a href="/profile.html">Profile</a>
    <a href="/subscriptions/premium.html">Premium Area</a>
  </nav>

  <div class="container">
    <h2>User Profile</h2>
    <div id="profile-content">Loading your profile...</div>
  </div>

  <script>
    const stripe = Stripe('pk_test_51SIBCAFF2HALdyFkP6v123abcDEF456ghiJKL789');

    async function loadProfile() {
      try {
        const response = await fetch('/api/me', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Not logged in or server error');
        }
        const user = await response.json();
        const active = user.subscription_active;
        const daysLeft = user.days_left || 0;

        document.getElementById('profile-content').innerHTML = `
          <h3>Welcome, <strong>${user.username}</strong>!</h3>
          <p>Email: ${user.email}</p>

          <p style="font-size:1.6rem; margin:40px 0; text-align:center;">
            Subscription: 
            <span style="font-weight:bold; color:${active ? 'green' : 'red'};">
              ${active ? 'ACTIVE' : 'INACTIVE'}
            </span>
          </p>

          ${active ? `
            <div style="text-align:center; margin:50px 0;">
              <p style="color:green; font-size:2rem; margin-bottom:20px;">
                Premium Access Active!
              </p>
              <p style="font-size:1.2rem; color:#333; margin-bottom:30px;">
                Your subscription has ${daysLeft} days left.
              </p>
              <button onclick="cancelSubscription()" class="btn-danger" 
                      style="padding:20px 50px; font-size:22px; font-weight:bold;">
                CANCEL SUBSCRIPTION NOW
              </button>
              <p style="color:#888; margin-top:15px;">
                Ends access immediately
              </p>
            </div>
          ` : `
            <div style="text-align:center; margin:50px 0;">
              <h3>Upgrade to Premium</h3>
              <button onclick="startCheckout('price_1SIBPkFF2HALdyFkogiGJG5w')" 
                      class="btn-primary" style="padding:18px 40px; font-size:20px; margin:10px;">
                Weekly – $2.95
              </button>
              <br>
              <button onclick="startCheckout('price_1SIBCzFF2HALdyFk7vOxByGq')" 
                      class="btn-success" style="padding:18px 40px; font-size:20px; margin:10px;">
                Monthly – $7.75
              </button>
            </div>
          `}

          <hr style="margin:60px 0; border:0; height:1px; background:#ddd;">

          <p style="text-align:center;">
            <button onclick="logoutUser()" class="btn-danger" style="padding:14px 30px; font-size:18px;">
              Logout
            </button>
          </p>
        `;
      } catch (error) {
        document.getElementById('profile-content').innerHTML = `
          <p style="color:red; text-align:center;">
            <strong>Not Logged In</strong><br>
            <a href="/login.html">Go to Login</a>
          </p>
        `;
      }
    }

    // Start checkout and redirect to Stripe
    async function startCheckout(priceId) {
      try {
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ price_id: priceId })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server error');
        }

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;  // Reliable redirect
        } else {
          throw new Error('No checkout URL provided');
        }
      } catch (error) {
        alert('Failed to start checkout: ' + error.message);
      }
    }

    // Cancel subscription
    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel? Access ends immediately.')) return;
      try {
        const response = await fetch('/api/cancel-subscription-now', {
          method: 'POST',
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Cancel failed');
        const data = await response.json();
        if (data.success) {
          alert('Subscription cancelled!');
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Failed to cancel: ' + error.message);
      }
    }

    // Logout
    async function logoutUser() {
      try {
        await fetch('/api/logout', { credentials: 'include' });
        window.location.href = '/';
      } catch (error) {
        alert('Logout failed: ' + error.message);
      }
    }

    // Auto-refresh after Stripe redirect to show updated status
    if (window.location.search.includes('session_id')) {
      setTimeout(() => window.location.href = '/profile.html', 1000);
    } else {
      loadProfile();
    }
  </script>
</body>
</html>