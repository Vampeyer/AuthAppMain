<!-- public/profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg,#1a3c34,#4b0082,#000); color:#fff; padding-top:80px; }
    .badge-active { background:#28a745; }
    .badge-inactive { background:#dc3545; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Movies App</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/profile.html">Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="/subscription/movie_content.html">Movies</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="text-center">
      <h1>User Profile</h1>
      <p><strong>Username:</strong> <span id="username">…</span></p>
      <p><strong>Email:</strong> <span id="email">…</span></p>
      <p><strong>Subscription:</strong> <span id="subBadge" class="badge">…</span></p>

      <div id="loggedIn" style="display:none;">
        <button id="weeklyBtn" class="btn btn-primary me-2">Weekly $2.95</button>
        <button id="monthlyBtn" class="btn btn-primary me-2">Monthly $7.75</button>
        <button id="cancelBtn" class="btn btn-danger">Cancel</button>
        <button id="logoutBtn" class="btn btn-warning mt-2">Logout</button>
      </div>

      <div id="notLoggedIn">
        <a href="/login.html" class="btn btn-success">Login</a>
        <a href="/signup.html" class="btn btn-info ms-2">Sign Up</a>
      </div>
    </div>
  </div>

  <script src="/protected/js/auth.js"></script>
  <script>
    async function loadProfile() {
      try {
        const r = await fetch(`${API_URL}/profile`, { credentials: 'include' });
        if (r.status === 401) return showNotLoggedIn();
        const d = await r.json();
        document.getElementById('username').textContent = d.username;
        document.getElementById('email').textContent = d.email;
        const badge = document.getElementById('subBadge');
        badge.textContent = d.subscription_active ? 'Active' : 'Inactive';
        badge.className = d.subscription_active ? 'badge badge-active' : 'badge badge-inactive';
        document.getElementById('loggedIn').style.display = 'block';
        document.getElementById('notLoggedIn').style.display = 'none';

        document.getElementById('weeklyBtn').disabled = d.subscription_active;
        document.getElementById('monthlyBtn').disabled = d.subscription_active;
        document.getElementById('cancelBtn').disabled = !d.subscription_active;
      } catch (e) { showNotLoggedIn(); }
    }
    function showNotLoggedIn() {
      document.getElementById('username').textContent = 'Not logged in';
      document.getElementById('email').textContent = '';
      document.getElementById('subBadge').textContent = 'Not logged in';
      document.getElementById('subBadge').className = 'badge';
      document.getElementById('loggedIn').style.display = 'none';
      document.getElementById('notLoggedIn').style.display = 'block';
    }

    async function subscribe(type) {
      const r = await fetch(`${API_URL}/create-checkout-session`, {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({type})
      });
      const d = await r.json();
      if (d.url) location.href = d.url;
    }
    async function cancel() {
      if (!confirm('Cancel subscription?')) return;
      await fetch(`${API_URL}/delete-subscription`, {method:'POST', credentials:'include'});
      loadProfile();
    }
    async function logout() {
      await fetch(`${API_URL}/logout`, {method:'POST', credentials:'include'});
      location.href='/login.html';
    }

    document.getElementById('weeklyBtn').onclick = ()=>subscribe('WEEKLY');
    document.getElementById('monthlyBtn').onclick = ()=>subscribe('MONTHLY');
    document.getElementById('cancelBtn').onclick = cancel;
    document.getElementById('logoutBtn').onclick = logout;

    window.addEventListener('load', loadProfile);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>